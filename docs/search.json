[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Personal blog of Luis Biedma: R, Economics and National Accounts",
    "section": "",
    "text": "ggplot and gghightlight\n\n\n\n\n\n\nggplot\n\n\nR\n\n\n\n\n\n\n\n\n\nJun 2, 2025\n\n\n\n\n\n\n\n\n\n\n\n\nRenta regional de los hogares\n\n\n\n\n\n\nRegional Accounts\n\n\nEurostat\n\n\nR\n\n\n\n\n\n\n\n\n\nJun 1, 2025\n\n\n\n\n\n\n\n\n\n\n\n\nSpain contribution to European GDP growth\n\n\n\n\n\n\nGDP\n\n\nEurostat\n\n\nR\n\n\n\n\n\n\n\n\n\nMar 15, 2025\n\n\n\n\n\n\nNo matching items"
  },
  {
    "objectID": "posts/post-with-code/index.html",
    "href": "posts/post-with-code/index.html",
    "title": "Post With Code",
    "section": "",
    "text": "This is a post with executable code."
  },
  {
    "objectID": "about.html",
    "href": "about.html",
    "title": "About",
    "section": "",
    "text": "About this blog"
  },
  {
    "objectID": "posts/welcome/index.html",
    "href": "posts/welcome/index.html",
    "title": "Welcome To My Blog",
    "section": "",
    "text": "This is the first post in a Quarto blog. Welcome!\n\nSince this post doesn’t specify an explicit image, the first image in the post will be used in the listing page of posts."
  },
  {
    "objectID": "posts/Spain contribution to European GDP growth/index.html",
    "href": "posts/Spain contribution to European GDP growth/index.html",
    "title": "Spain contribution to European GDP growth",
    "section": "",
    "text": "A journalist recently asked my colleagues if an statement from a politician was true. The statement was that Spain represented half of the European growth. In this (first) post, we would learn how to calculate that metric using Eurostat data and a bit of R."
  },
  {
    "objectID": "posts/Spain contribution to European GDP growth/index.html#annual-data",
    "href": "posts/Spain contribution to European GDP growth/index.html#annual-data",
    "title": "Spain contribution to European GDP growth",
    "section": "Annual data",
    "text": "Annual data\nFirst, I will show the more direct way to do it for annual data. If we want to calculate it for 2024, we need to get the data for Spain and the EU (or Euro area) for 2023 in current prices and for 2024 in previous year prices (prices of 2023). By difference, we can calculate the volume change in both areas.\nFirst we load the libraries.\n\nlibrary(eurostat)\nlibrary(dplyr)\nlibrary(tidyr)\n\nAnd we collect the data we need. First, the year 2023 in current prices:\n\ndat_23 &lt;- get_eurostat(\"nama_10_gdp\", \n                    filters = list(geo = c(\"ES\", \"EA20\", \"EU27_2020\"),\n                                   na_item = \"B1GQ\",\n                                   unit = c(\"CP_MEUR\"),\n                                   time_period = 2023),\n                    time_format = \"num\") |&gt; \n  select(geo, time, values)\n\nknitr::kable(dat_23)\n\n\n\n\ngeo\ntime\nvalues\n\n\n\n\nEU27_2020\n2023\n17197822\n\n\nEA20\n2023\n14598181\n\n\nES\n2023\n1498324\n\n\n\n\n\nAnd after, the year 2024 in previous year prices:\n\ndat_24 &lt;- get_eurostat(\"nama_10_gdp\", \n                    filters = list(geo = c(\"ES\", \"EA20\", \"EU27_2020\"),\n                                   na_item = \"B1GQ\",\n                                   unit = c(\"PYP_MEUR\"),\n                                   time_period = 2024),\n                    time_format = \"num\") |&gt; \n  select(geo, time, values)\n\nknitr::kable(dat_24)\n\n\n\n\ngeo\ntime\nvalues\n\n\n\n\nEU27_2020\n2024\n17372727\n\n\nEA20\n2024\n14722950\n\n\nES\n2024\n1546966\n\n\n\n\n\nWe bind them together and calculate the change between 2024 and 2023:\n\ndat &lt;- bind_rows(dat_23, dat_24) |&gt; \n  pivot_wider(names_from = time,\n              values_from = values) |&gt; \n  mutate(change = `2024` - `2023`,\n         change_p = round(change / `2023` * 100, 2))  \n\nknitr::kable(dat)\n\n\n\n\ngeo\n2023\n2024\nchange\nchange_p\n\n\n\n\nEU27_2020\n17197822\n17372727\n174905.4\n1.02\n\n\nEA20\n14598181\n14722950\n124768.8\n0.85\n\n\nES\n1498324\n1546966\n48642.0\n3.25\n\n\n\n\n\nSpain grew by 3.25 in 2024 and the EU by 1.02. But as we are looking for the contribution, we need to divide the change in Spain with the change in the EU.\n\ncont_es_24_eu &lt;- round(dat |&gt; filter(geo == \"ES\") |&gt; select(change) |&gt; pull() / \n                       dat |&gt; filter(geo == \"EU27_2020\") |&gt; select(change) |&gt; pull()\n                       * 100, 2)\n\ncont_es_24_ea &lt;- round(dat |&gt; filter(geo == \"ES\") |&gt; select(change) |&gt; pull() / \n                       dat |&gt; filter(geo == \"EA20\") |&gt; select(change) |&gt; pull()\n                       * 100, 2)\n\nFor the EU aggregate the contribution by Spain was 27.81 and for the Euro area 38.99."
  },
  {
    "objectID": "posts/Spain contribution to European GDP growth/index.html#quarterly-data",
    "href": "posts/Spain contribution to European GDP growth/index.html#quarterly-data",
    "title": "Spain contribution to European GDP growth",
    "section": "Quarterly data",
    "text": "Quarterly data\nFor quarterly data, to compare the fourth quarter of 2024 with the fourth quarter of 2023, we cannot compare current prices in 2023Q4, which are measured at the prices of 2023Q4, with the previous year prices of 2024Q4, which are measured at the prices of 2023. The easiest way is to use the 2023Q4 in current prices as weights for the start of the period and calculate the change between 2024Q4 and 2023Q4 in chain linked series, which provide the volume evolution.\nFirst the current prices for 2023Q4:\n\ndat_23_q4 &lt;- get_eurostat(\"namq_10_gdp\", \n                    filters = list(geo = c(\"ES\", \"EA20\", \"EU27_2020\"),\n                                   na_item = \"B1GQ\",\n                                   unit = c(\"CP_MEUR\"),\n                                   s_adj = \"SCA\",\n                                   time_period = \"2024-Q4\"),\n                    time_format = \"raw\") |&gt; \n  select(geo, time, values)\n\nknitr::kable(dat_23_q4)\n\n\n\n\ngeo\ntime\nvalues\n\n\n\n\nEU27_2020\n2024-Q4\n4554634\n\n\nEA20\n2024-Q4\n3842814\n\n\nES\n2024-Q4\n407457\n\n\n\n\n\nAnd then the chain linked data for 2024Q4 and 2023Q4.\n\ndat_24_q4 &lt;- get_eurostat(\"namq_10_gdp\", \n                    filters = list(geo = c(\"ES\", \"EA20\", \"EU27_2020\"),\n                                   na_item = \"B1GQ\",\n                                   unit = c(\"CLV20_MEUR\"),\n                                   s_adj = \"SCA\",\n                                   time_period = c(\"2023-Q4\",\"2024-Q4\")),\n                    time_format = \"raw\") |&gt; \n  select(geo, time, values)\n\nknitr::kable(dat_24_q4)\n\n\n\n\ngeo\ntime\nvalues\n\n\n\n\nEU27_2020\n2023-Q4\n3758731\n\n\nEU27_2020\n2024-Q4\n3810585\n\n\nEA20\n2023-Q4\n3213335\n\n\nEA20\n2024-Q4\n3250471\n\n\nES\n2023-Q4\n331427\n\n\nES\n2024-Q4\n342982\n\n\n\n\n\nWe compute the change between 2024Q4 and 2023Q4.\n\nq_change &lt;- dat_24_q4 |&gt;\n  pivot_wider(names_from = time,\n              values_from = values) |&gt; \n  mutate(change_p = round(`2024-Q4` / `2023-Q4` * 100-100, 3))\n\nknitr::kable(dat_24_q4)\n\n\n\n\ngeo\ntime\nvalues\n\n\n\n\nEU27_2020\n2023-Q4\n3758731\n\n\nEU27_2020\n2024-Q4\n3810585\n\n\nEA20\n2023-Q4\n3213335\n\n\nEA20\n2024-Q4\n3250471\n\n\nES\n2023-Q4\n331427\n\n\nES\n2024-Q4\n342982\n\n\n\n\n\nSpain grew by 3.486 between 2024Q4 and 2023Q4 and the EU by 1.38.\nWe combine both datasets to calculate the contribution:\n\ndat_23_q4$time &lt;- NULL\nq_change &lt;- q_change |&gt; \n  select(geo,change_p) \n  \ncontrib_q &lt;- full_join(dat_23_q4, q_change) |&gt; \n  mutate(contrib = values * change_p)\n\nknitr::kable(contrib_q)\n\n\n\n\ngeo\nvalues\nchange_p\ncontrib\n\n\n\n\nEU27_2020\n4554634\n1.380\n6285395\n\n\nEA20\n3842814\n1.156\n4442293\n\n\nES\n407457\n3.486\n1420395\n\n\n\n\n\n\ncont_es_24q4_eu &lt;- round(contrib_q |&gt; filter(geo == \"ES\") |&gt; select(contrib) |&gt; pull() / \n                       contrib_q |&gt; filter(geo == \"EU27_2020\") |&gt; select(contrib) |&gt; pull()\n                       * 100, 2)\n\ncont_es_24q4_ea &lt;- round(contrib_q |&gt; filter(geo == \"ES\") |&gt; select(contrib) |&gt; pull() / \n                       contrib_q |&gt; filter(geo == \"EA20\") |&gt; select(contrib) |&gt; pull()\n                       * 100, 2)\n\nFor the EU the contribution was 22.6 and for the Euro area 31.97.\nIt seems that the statement was not correct, although my guess is that probably the politician was adding Portugal and referring to the Euro area. I leave it as an exercise to calculate the contribution of Spain and Portugal."
  },
  {
    "objectID": "posts/bookmarks_20250316/index.html",
    "href": "posts/bookmarks_20250316/index.html",
    "title": "Bookmarks 20250316",
    "section": "",
    "text": "I collect for reference some of the readings I found interesting/useful this week.\n\ndata.table vs dplyr: A Side-by-Side Comparison https://albert-rapp.de/posts/34_datatable_vs_dplyr/34_datatable_vs_dplyr.html\n\nAs I need to use (read/write) data.table quite often but I am still more familiar with dplyr, all references are useful.\n\n¿Por qué el Gasto Público forma parte del PIB? https://nadaesgratis.es/antonia-diaz/por-que-el-gasto-publico-forma-parte-del-pib\n\nNo estoy muy de acuerdo en que sea correcto añadir los automóviles de los particulares al stock de capital y calcular una depreciación para ellos.\n\nBuild a Personal Website with Quarto & Github Pages | Lesson 4, Websites and Dashboards with R https://www.youtube.com/watch?v=OlvO-EG-P60\n\nNice youtube tutorial that helped me a lot to build this site on github pages. There are also other useful tutorials for quarto dashboards and basic understanding of using git.\n\nA Country Is Not a Company by Paul Krugman https://hbr.org/1996/01/a-country-is-not-a-company\n\nA classic article that I probably read a long time ago but that I find quite insighful."
  },
  {
    "objectID": "posts/Expenditure on defense/index.html",
    "href": "posts/Expenditure on defense/index.html",
    "title": "Expenditure on defence",
    "section": "",
    "text": "https://ec.europa.eu/eurostat/web/products-manuals-and-guidelines/w/ks-gq-23-002\n\nlibrary(eurostat)\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(ggplot2)\n\n\ndat &lt;- get_eurostat(\"gov_10a_exp\", \n                    filters = list(geo = c(\"ES\",\"EU27_2020\"),\n                                   sector = \"S13\",\n                                   unit = c(\"MIO_EUR\", \"PC_GDP\"),\n                                   cofog99 = c(\"GF02\", \"GF0201\", \"GF0202\", \"GF0203\", \"GF0204\", \"GF0205\")),\n                    time_format = \"num\") |&gt; \n  na.omit()\n\nlabels_cofog &lt;- get_eurostat_dic(\"cofog99\") |&gt; \n  select(cofog99 = code_name, cofog99_label = full_name)\n\nlabels_na_item &lt;- get_eurostat_dic(\"na_item\") |&gt; \n  select(na_item = code_name, na_item_label = full_name)\n\ndat &lt;- left_join(dat, labels_cofog) %&gt;%\n  left_join(.,labels_na_item)\n\n\ndat |&gt; filter(cofog99 == \"GF02\" & na_item == \"TE\" & unit == \"PC_GDP\") |&gt; \n  ggplot(aes(x = time, y = values, colour = geo)) +\n  geom_line()"
  },
  {
    "objectID": "posts/Negative emissions footprints/index.html",
    "href": "posts/Negative emissions footprints/index.html",
    "title": "Negative emissions footprints",
    "section": "",
    "text": "https://ec.europa.eu/eurostat/web/products-manuals-and-guidelines/w/ks-gq-23-002\n\nlibrary(eurostat)\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(ggplot2)\n\n\ndat &lt;- get_eurostat(\"env_ac_ghgfp\", \n                    filters = list(time_period = 2020),\n                    time_format = \"num\") |&gt; \n  na.omit()\n\nlabels_cofog &lt;- get_eurostat_dic(\"cofog99\") |&gt; \n  select(cofog99 = code_name, cofog99_label = full_name)\n\nlabels_na_item &lt;- get_eurostat_dic(\"na_item\") |&gt; \n  select(na_item = code_name, na_item_label = full_name)\n\ndat &lt;- left_join(dat, labels_cofog) %&gt;%\n  left_join(.,labels_na_item)\n\n\ndat |&gt; filter(cofog99 == \"GF02\" & na_item == \"TE\" & unit == \"PC_GDP\") |&gt; \n  ggplot(aes(x = time, y = values, colour = geo)) +\n  geom_line()"
  },
  {
    "objectID": "posts/Renta regional de los hogares/index.html",
    "href": "posts/Renta regional de los hogares/index.html",
    "title": "Renta regional de los hogares",
    "section": "",
    "text": "El confidencial ha publicado un artículo (https://www.elconfidencial.com/economia/2025-05-31/solo-quedan-dos-ccaa-ingresos-hogares-media-ue_4141354/) que ha tenido cierta repercusión en algunos twitteros “económicos” que sigo. El artículo se basa en una publicación de Eurostat (https://ec.europa.eu/eurostat/statistics-explained/index.php?title=Regional_household_income_statistics) que es básicamente la publicación que preparé hace cuatro años. Me llevó bastante tiempo prepararlo porque quería evitar el típico anodino artículo (X creció Y% en al año Z) y el código con el que preparé el mock-up todavía está disponible (https://github.com/eurostat/statistics-coded/blob/master/economy/regional_household_income/statistics_coded_regional_HHI.Rmd).\nEstos días he estado leyendo el libro “La factura del cupo catalán. Privilegios territoriales frente a ciudadanía” (La Esfera de los Libros, 2025) de JFV y Francisco de la Torre (muy recomendable!).\nPuse un cuadro explicativo de por qué no es buena idea comparar la renta disponible (código B6N) de regiones de diferentes países después de algunas discusiones con usuarios holandeses que se escandalizaban de que algunas regiones italianas estuvieran por encima de las holandeses. Habría que usar la renta disponible ajustada (B7N) pero no está disponible (sólo para España).\nSobre todo recuerdo lo que me costó explicar el mapa M3. En el se calcula la renta primaria (B5N) y la renta disponibles per capita de los hogares (B6N) y se pone en relación a la media nacional (indice 100). Luego se calcula el ratio entre B6N y B5N. Si el ratio es mayor que 100 indica que la región mejora (relativamente) y si es menor que empeora(relativamente). Se espera, y se cumple, que en general las que están por encima de la media para B5G empeoran y viceversa.\nPara comparar actualizo el cálculo para los países federales (Alemania, Austria, Bélgica y España).\n\npacman::p_load(dplyr,tidyr,stringr,eurostat, ggplot2, luispack,ggtext)\n\nhh2 &lt;- get_eurostat(\"nama_10r_2hhinc\", time_format = \"num\")\n\n\nindexed 0B in  0s, 0B/s\nindexed 2.15GB in  0s, 2.15GB/s\n                                                                              \n\npop3 &lt;- get_eurostat(\"nama_10r_3popgdp\", time_format = \"num\")\n\n\nindexed 0B in  0s, 0B/s\nindexed 2.15GB in  0s, 2.15GB/s\n                                                                              \n\ntemp &lt;- hh2 %&gt;%\n  unite(na_item, c(na_item, direct)) %&gt;%\n  filter(unit == \"MIO_NAC\"& na_item %in% c(\"B5N_BAL\", \"B6N_BAL\")) %&gt;%\n  pivot_wider(\n    names_from = na_item,\n    values_from = values\n  ) %&gt;%\n  mutate(\n    country = str_sub(geo, 1, 2),\n    NUTS = str_length(geo) - 2\n  ) %&gt;%\n  filter(NUTS %in% c(\"0\", \"2\") & country %in% c(\"AT\",\"BE\", \"DE\", \"ES\")) %&gt;%\n  select(geo, country, NUTS, TIME_PERIOD, B5N_BAL, B6N_BAL) %&gt;%\n  pivot_longer(\n    cols = c(\"B5N_BAL\", \"B6N_BAL\"),\n    names_to = \"na_item\",\n    values_to = \"values\"\n  )\n\npop &lt;- pop3 %&gt;%\n  select(-unit) %&gt;%\n  rename(pop = values)\n\ntemp &lt;- left_join(temp, pop) %&gt;%\n  mutate(percapita = values * 1000 / pop) %&gt;%\n  droplevels() %&gt;%\n  group_by(country, na_item, TIME_PERIOD) %&gt;%\n  mutate(nat_percapita = percapita * 100 / percapita[NUTS == \"0\"]) %&gt;%\n  filter(NUTS == \"2\") %&gt;%\n  select(geo, na_item, TIME_PERIOD,nat_percapita) %&gt;%\n  pivot_wider(\n    names_from = na_item,\n    values_from = nat_percapita\n  ) %&gt;%\n  mutate(ratio = round(B6N_BAL * 100 / B5N_BAL, 1)) |&gt; \n  na.omit()\n\nLo he hecho para todos los años disponibles, 2000-2023 para Austria y Bélgica y 2000-2022 para Alemania y España. Para tener una visión global los pongo en un gráfico. Primero veamos la dispersión de los índices per capita respecto a la medio nacional.\n\nggplot(temp)+\n  geom_point(aes(TIME_PERIOD,B5N_BAL),colour = \"#2644A7\", alpha = 0.7)+\n  geom_point(aes(TIME_PERIOD,B6N_BAL),colour = \"#AF155C\", alpha = 0.7)+\n  facet_wrap(vars(country))+\n  theme_luis()+\n   labs(title = \"&lt;span style = 'font-size:14pt;color:#2644A7;'&gt;B5N &lt;/span&gt;&lt;span style = 'font-size:14pt;color:#AF155C;'&gt;B6N&lt;/span&gt;\",\n        subtitle = \"100 = Media nacional\"\n  ) +\n  theme(\n    plot.title = element_markdown(size = 11, lineheight = 1.2)\n  )\n\n\n\n\n\n\n\n\nVemos que en Austria las diferencias en B5N son bastante pequeñas aunque habría que mirar los detalles. Los valores más bajos para España son Ceuta y Melilla que no son muy significativas.\nAhora mirando el ratio, vemos que en España hay sólo tres regiones que empeoran (Madrid, Baleares y Cataluña). Navarra está en el 99.9 ppero lo he redondeado a 100. El tamaño del ajuste para Madrid es similar al de Oberbayern o Hamburgo o el Bravante Flamenco..perdiendo unos 10 puntos.\n\nggplot(temp)+\n  geom_point(aes(TIME_PERIOD,ratio),colour = \"#E04040\")+\n  geom_hline(yintercept = 100, colour = \"grey10\")+\n  facet_wrap(vars(country))+\n  theme_luis()+\n  labs(title = \"Ratio B5N/B6N\")\n\n\n\n\n\n\n\n\nAcabo calculando el mismo indicador para la Renta Disponible Ajustada (B7N), que es B6N más D63, que son transferencias sociales en especie que básicamente provee el gobierno (nacional o regional). Básicamente sanidad, educación, vivienda, defensa… Este gráfico confirma claramente la tesis del libro de que la situación del País Vasco es una anomalía.\n\ntemp &lt;- hh2 %&gt;%\n  unite(na_item, c(na_item, direct)) %&gt;%\n  filter(unit == \"MIO_NAC\"& na_item %in% c(\"B5N_BAL\", \"B6N_BAL\", \"B7N_BAL\")) %&gt;%\n  pivot_wider(\n    names_from = na_item,\n    values_from = values\n  ) %&gt;%\n  mutate(\n    country = str_sub(geo, 1, 2),\n    NUTS = str_length(geo) - 2\n  ) %&gt;%\n  filter(NUTS %in% c(\"0\", \"2\") & country %in% c( \"ES\")) %&gt;%\n  select(geo, country, NUTS, TIME_PERIOD, B5N_BAL, B6N_BAL, B7N_BAL) %&gt;%\n  pivot_longer(\n    cols = c(\"B5N_BAL\", \"B6N_BAL\", \"B7N_BAL\"),\n    names_to = \"na_item\",\n    values_to = \"values\"\n  )\n\n\ntemp &lt;- left_join(temp, pop) %&gt;%\n  mutate(percapita = values * 1000 / pop) %&gt;%\n  droplevels() %&gt;%\n  group_by(country, na_item, TIME_PERIOD) %&gt;%\n  mutate(nat_percapita = percapita * 100 / percapita[NUTS == \"0\"]) %&gt;%\n  filter(NUTS == \"2\") %&gt;%\n  select(geo, na_item, TIME_PERIOD,nat_percapita) %&gt;%\n  pivot_wider(\n    names_from = na_item,\n    values_from = nat_percapita\n  ) %&gt;%\n  mutate(ratio_B6_B5 = round(B6N_BAL * 100 / B5N_BAL, 1),\n         ratio_B7_B5 = round(B7N_BAL * 100 / B5N_BAL, 1)) |&gt; \n  na.omit() |&gt; \n  filter(geo %in% c(\"ES21\", \"ES22\", \"ES30\", \"ES51\", \"ES53\")) |&gt; \n  select(geo,TIME_PERIOD,ratio_B6_B5, ratio_B7_B5) |&gt; \n  pivot_longer(cols = c(ratio_B6_B5, ratio_B7_B5),\n               names_to = \"ratio\",\n               values_to = \"values\") |&gt; \n  mutate(label = case_when(geo == \"ES21\" ~ \"País Vasco\",\n                           geo == \"ES22\" ~ \"Comunidad Foral de Navarra\",\n                           geo == \"ES30\" ~ \"Comunidad de Madrid\",\n                           geo == \"ES51\" ~ \"Cataluña\",\n                           geo == \"ES53\" ~ \"Illes Balears\"))\n\nggplot(temp,aes(TIME_PERIOD, values,colour = ratio))+\n  geom_line(linewidth = 0.75)+\n  facet_wrap(~label)+\n  theme_luis()+\n  scale_colour_luis()+\n  theme(legend.position = \"top\", legend.justification = \"right\")"
  },
  {
    "objectID": "posts/ggplot_gghighlight/index.html",
    "href": "posts/ggplot_gghighlight/index.html",
    "title": "ggplot and gghightlight",
    "section": "",
    "text": "While preparing the previous post I wanted to do a nicer chart but I did not remember exactly how to do it. I wanted to have small multiples showing all lines in grey and highlighting the region shown in the chart. It was enough to remember how to add colours to the title with {ggtext}!. I remembered that there is a library for that (https://cran.r-project.org/web/packages/gghighlight/vignettes/gghighlight.html) and I included this chart in a training(https://r-graph-gallery.com/web-line-chart-small-multiple-all-group-greyed-out.html. But also remembered having seen in a post a simpler way to do it. After 15 minutes search I found it again and I put it here for the next time I need it (https://ikashnitsky.phd/2020/background-data/).\nSo let illustrate what to do. I will download D63 for the Spanish regions.\n\npacman::p_load(tidyverse, eurostat, luispack, ggtext)\n\nhh2 &lt;- get_eurostat(\"nama_10r_2hhinc\", time_format = \"num\")\npop3 &lt;- get_eurostat(\"nama_10r_3popgdp\", time_format = \"num\")\n\ntemp &lt;- hh2 %&gt;%\n  filter(unit == \"MIO_NAC\" & na_item %in% c(\"D63\") & str_detect(geo, \"ES\")) |&gt;\n  select(geo, TIME_PERIOD, D63 = values) |&gt;\n  left_join(pop3) |&gt;\n  mutate(D63p = D63 * 1000 / values) |&gt;\n  select(geo, TIME_PERIOD, D63p)\n\nlabels &lt;- data.frame(\n  geo = c(\n    \"ES11\",\n    \"ES12\", \"ES13\", \"ES21\", \"ES22\", \"ES23\", \"ES24\",\n    \"ES30\", \"ES41\", \"ES42\", \"ES43\", \"ES51\", \"ES52\",\n    \"ES53\", \"ES61\", \"ES62\", \"ES63\", \"ES64\", \"ES70\",\n    \"ES\"\n  ),\n  label = c(\n    \"Galicia\",\n    \"Principado de Asturias\", \"Cantabria\",\n    \"País Vasco\", \"Comunidad Foral de Navarra\", \"La Rioja\",\n    \"Aragón\", \"Comunidad de Madrid\",\n    \"Castilla y León\", \"Castilla-La Mancha\", \"Extremadura\",\n    \"Cataluña\", \"Comunitat Valenciana\", \"Illes Balears\",\n    \"Andalucía\", \"Región de Murcia\",\n    \"Ciudad de Ceuta\", \"Ciudad de Melilla\", \"Canarias\",\n    \"España\"\n  )\n)\n\ntemp &lt;- left_join(temp, labels) |&gt;\n  na.omit()\n\nI have the data ready and I could do a normal chart.\n\nggplot() +\n  geom_line(data = temp |&gt; filter(geo != \"ES\"), aes(TIME_PERIOD, D63p), linewidth = 0.7, colour = \"#2644A7\") +\n  facet_wrap(vars(label)) +\n  theme_luis() +\n  theme(strip.text = element_text(size = 11))\n\n\n\n\n\n\n\n\nNot bad but not impressive. We could add as a separate line the D63 per capita for the country to make the comparison easier.\n\nggplot() +\n  geom_line(data = temp |&gt; filter(geo != \"ES\"), aes(TIME_PERIOD, D63p), linewidth = 0.7, colour = \"#2644A7\") +\n  geom_line(data = temp |&gt; filter(geo == \"ES\") |&gt; select(-label), aes(TIME_PERIOD, D63p), linewidth = 0.7, colour = \"#AF155C\") +\n  facet_wrap(vars(label)) +\n  theme_luis() +\n  theme(strip.text = element_text(size = 11))\n\n\n\n\n\n\n\n\nA bit better but here comes the trick. We want to plot all regions in all charts but with a light grey. We can add another geom and remove the variable like in Spain but in order to have lines we need to group by geo. If we did not have geo as an extra column we would need to dupplicate the column label and give it another name. Of course it has to be the first geom otherwise we will hide the single region and national lines.\n\nggplot() +\n  geom_line(data = temp |&gt; filter(geo != \"ES\") |&gt; select(-label), aes(TIME_PERIOD, D63p, group = geo), linewidth = 0.5, colour = \"grey80\") +\n  geom_line(data = temp |&gt; filter(geo != \"ES\"), aes(TIME_PERIOD, D63p), linewidth = 0.7, colour = \"#2644A7\") +\n  geom_line(data = temp |&gt; filter(geo == \"ES\") |&gt; select(-label), aes(TIME_PERIOD, D63p), linewidth = 0.7, colour = \"#AF155C\") +\n  facet_wrap(vars(label)) +\n  theme_luis() +\n  labs(\n    title = \"Regional Social Transfers in Kind per capita\",\n    subtitle = \"&lt;span style = 'color:#AF155C;'&gt;Spain &lt;/span&gt;\"\n  ) +\n  theme(\n    strip.text = element_text(size = 11),\n    plot.subtitle = element_markdown(size = 11, lineheight = 1.2)\n  )\n\n\n\n\n\n\n\n\nAnd the final touch. Add the values for the last year.\n\nggplot() +\n  geom_line(data = temp |&gt; filter(label != \"España\") |&gt; select(-label), aes(TIME_PERIOD, D63p, group = geo), linewidth = 0.5, colour = \"grey80\") +\n  geom_line(data = temp |&gt; filter(label != \"España\"), aes(TIME_PERIOD, D63p), linewidth = 0.7, colour = \"#2644A7\") +\n  geom_line(data = temp |&gt; filter(label == \"España\") |&gt; select(-label), aes(TIME_PERIOD, D63p), linewidth = 0.7, colour = \"#AF155C\") +\n  geom_text(\n    data = temp %&gt;%\n      filter(label != \"España\") |&gt;\n      group_by(label) |&gt;\n      slice_max(TIME_PERIOD),\n    aes(x = 2021, y = 2500, label = round(D63p)), color = \"#2644A7\", size = 3.5\n  ) +\n  facet_wrap(vars(label)) +\n  theme_luis() +\n  labs(\n    title = \"Regional Social Transfers in Kind per capita\",\n    subtitle = \"&lt;span style = 'color:#AF155C;'&gt;Spain = 3781 in 2022 &lt;/span&gt;\"\n  ) +\n  theme(\n    strip.text = element_text(size = 11),\n    plot.subtitle = element_markdown(size = 11, lineheight = 1.2)\n  )"
  }
]